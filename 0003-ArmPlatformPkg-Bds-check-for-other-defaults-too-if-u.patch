From 4485503a18aa9279038475adc0957f44b685f11b Mon Sep 17 00:00:00 2001
From: Laszlo Ersek <lersek@redhat.com>
Date: Fri, 13 Dec 2013 22:02:37 +0100
Subject: [PATCH 3/9] ArmPlatformPkg/Bds: check for other defaults too if user
 pref is unset

Contributed-under: TianoCore Contribution Agreement 1.0
Signed-off-by: Laszlo Ersek <lersek@redhat.com>
---
 ArmPlatformPkg/Bds/Bds.c   | 63 +++++++++++++++++++++++++++++++++++++++++++---
 ArmPlatformPkg/Bds/Bds.inf |  1 +
 2 files changed, 60 insertions(+), 4 deletions(-)

diff --git a/ArmPlatformPkg/Bds/Bds.c b/ArmPlatformPkg/Bds/Bds.c
index dd391b1..b197c96 100644
--- a/ArmPlatformPkg/Bds/Bds.c
+++ b/ArmPlatformPkg/Bds/Bds.c
@@ -18,6 +18,7 @@
 #include <Library/PerformanceLib.h>
 
 #include <Protocol/Bds.h>
+#include <Protocol/SimpleFileSystem.h>
 
 #include <Guid/EventGroup.h>
 #include <Guid/Gpt.h>
@@ -211,6 +212,63 @@ InitializeConsole (
   return EFI_SUCCESS;
 }
 
+STATIC
+EFI_STATUS
+FindCandidate (
+  IN  EFI_HANDLE       Handle,
+  OUT EFI_DEVICE_PATH  **Candidate
+  )
+{
+  EFI_STATUS                      Status;
+  EFI_SIMPLE_FILE_SYSTEM_PROTOCOL *FileSystem;
+  EFI_FILE_PROTOCOL               *RootDir;
+  CONST CHAR16 *CONST             *FileName;
+  CONST CHAR16 *CONST             Candidates[] = {
+    EFI_REMOVABLE_MEDIA_FILE_NAME,
+    L"\\Image",
+    L"\\EFI\\redhat\\grubaa64.efi",
+    L"\\EFI\\fedora\\grubaa64.efi",
+    NULL
+  };
+
+  Status = gBS->HandleProtocol (Handle, &gEfiSimpleFileSystemProtocolGuid,
+                  (VOID **) &FileSystem);
+  if (EFI_ERROR (Status)) {
+    return Status;
+  }
+  Status = FileSystem->OpenVolume (FileSystem, &RootDir);
+  if (EFI_ERROR (Status)) {
+    return Status;
+  }
+
+  for (FileName = Candidates; *FileName != NULL; ++FileName) {
+    EFI_FILE_PROTOCOL *File;
+
+    Status = RootDir->Open (RootDir, &File, (CHAR16 *) *FileName,
+                        EFI_FILE_MODE_READ, 0);
+    if (!EFI_ERROR (Status)) {
+      File->Close (File);
+      break;
+    }
+  }
+  if (*FileName == NULL) {
+    Status = EFI_NOT_FOUND;
+    goto CloseRoot;
+  }
+
+  *Candidate = FileDevicePath (Handle, *FileName);
+  if (*Candidate == NULL) {
+    Status = EFI_OUT_OF_RESOURCES;
+    goto CloseRoot;
+  }
+
+  DEBUG ((EFI_D_INFO, "%a: found \"%s\"\n", __FUNCTION__, *FileName));
+
+CloseRoot:
+  RootDir->Close (RootDir);
+  return Status;
+}
+
 EFI_STATUS
 DefineDefaultBootEntries (
   VOID
@@ -248,10 +306,7 @@ DefineDefaultBootEntries (
                       &NrHandles, &Handles);
       if (!EFI_ERROR (Status)) {
         ASSERT (NrHandles > 0);
-        BootDevicePath = FileDevicePath (Handles[0], L"Image");
-        if (BootDevicePath == NULL) {
-          Status = EFI_OUT_OF_RESOURCES;
-        }
+        Status = FindCandidate (Handles[0], &BootDevicePath);
         FreePool (Handles);
       }
       if (EFI_ERROR (Status)) {
diff --git a/ArmPlatformPkg/Bds/Bds.inf b/ArmPlatformPkg/Bds/Bds.inf
index ad10045..d9a8a4c 100644
--- a/ArmPlatformPkg/Bds/Bds.inf
+++ b/ArmPlatformPkg/Bds/Bds.inf
@@ -66,6 +66,7 @@
   gEfiFirmwareVolumeBlock2ProtocolGuid
   gEfiDhcp4ServiceBindingProtocolGuid
   gEfiMtftp4ServiceBindingProtocolGuid
+  gEfiSimpleFileSystemProtocolGuid
 
 [Pcd]
   gArmPlatformTokenSpaceGuid.PcdFirmwareVendor
-- 
1.8.3.1

